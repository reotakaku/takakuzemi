---
title: "卒論作成に必要なRのスキルのまとめ"
author: "一橋大学経済学部 　高久玲音"
date: "2022/4/1"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

昨年の第1期生は約半数程度がRをそこそこ使いこなして卒論を書いてた一方で、問題設定は良くとも詳細な分析までたどり着けない卒論もあった。卒論に必要だと思われるRのコーディングスキルはそれほど難易度的に高くないものも多いが、Rは経済学以外でも使われているため、経済学部の学生が卒論でよく使うコードがまとめられた文献も少ない印象。

そこで、高久先生が昨年度実施した大規模なアンケート調査を実際に解析してみて、卒論執筆までにどのようなコードが書ければ良いのかおさらいしてみよう。調査は2021年8月に約400万円をかけて実施されたweb調査で約3万人を対象に行われた。調査票は別途配っているので確認し、様々な分析を試してみましょう。

・vdata1.csv 8月6日から数日間行われた第一回調査。22000人程度

・vdata1.csv 8月20日前後に行われた追加調査。8000人程度

なお、調査はワクチン摂取の勧奨が65歳以上に対して優先されていたことに着目し、65歳の前後3歳の方を対象としています。実際の解析は65歳での摂取率のジャンプを利用した回帰不連続デザインですが、その他にもワクチンの摂取についての有用な情報が含まれていると思いますので、適宜解析すると良いでしょう。


データを読み込みます。


```{r setup}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("ggplot2")
library(ggplot2)
#install.packages("tidyverse")
library(tidyverse)

setwd("C:/Users/takak/Dropbox/lecture/2022/zemi/Vaccine")

vdata1 <- read.csv("vdata1.csv")

#データの先頭行をみてみましょう
head(vdata1[1:10])
```



最近はパイプ%>%を用いてデータの受け渡しを行うのが主流となっています。 パイプはmagrittrパッケージの機能ですが、tidyverseと同時にインストールされています。データ前処理にはdplyr（読み：ディープライアール）というパッケージの関数を主に用います。 dplyrはtidyverseの一部なので、tidyverseがインストールされていればOKです。なお、MACは Control + Shift + m で %>% を出力できます. Windowsは Ctrl + Shift + m で %>% を出力できます（ショートカット）.覚えておくと便利です。

```{r}


#データの先頭行をパイプを用いてみてみましょう

vdata1[1:10] %>% head()
```
この結果は、前のChapterで見たhead(saving)と同じ結果です。 パイプを用いると、パイプの前のオブジェクトをパイプの後の関数の引数としてくれます。

パイプを用いた書き方は以下のとおりです。

・使用するオブジェクトを示す: vdata1

・パイプでつなぐ: %>%

・使用する関数を書く: head() mean() table()

別の例を見てみましょう。sc2_1_1は調査対象者の生年、sc2_1_2は生まれ月です。以下の例で確認してください。

```{r}
#変数の平均を出力
vdata1$sc2_1_1 %>% mean()

#変数の値の分布を出力
vdata1$sc2_1_1 %>% table()
vdata1$sc2_1_2 %>% table()

```
★練習問題

1．パイプを用いて100の平方根を求めてください

2．パイプを用いて調査対象者の生年の中央値を求めてください


```{r}
100 %>% sqrt()
vdata1$sc2_1_1 %>% median()
```
変数の作成について。
まずは回答者が女性である場合に１を取る2値変数を作ってみましょう。変数の作成にはmutate()という関数を用います。また2つのカテゴリ（男性or 女性）しかない場合にはif_elase関数を組み合わせて用いると変数が作成できます。sc3 = 2なら女性、１なら男性です。

```{r}

vdata1 <- vdata1 %>% mutate(Fem = if_else(sc3 == 2,1,0))
mean(vdata1$Fem)

```
次にワクチンの接種状況に関する変数（1.2回以上摂取、2. 1回以上摂取）を作成しましょう。本人の摂取状況の質問はq6_2_1で回答は以下です。


1 	２回接種した

2 	１回接種しており、次の接種の予定も決まっている

3 	１回接種したが、次の接種の予定が決まっていない

4 	１回も接種していないが、最初の接種の予定は決まっている

5 	接種券を受け取ったが１回も接種しておらず、接種の予定も決まっていない

6 	１回も接種しておらず、接種の予定も決まっていない

7 	あてはまるものはない


```{r}
#最初に回答の分布を確認しましょう

vdata1$q6_2_1 %>% table()

#回答が7の場合には摂取状況が不明なのでNAに変換しましょう

vdata1 <- vdata1 %>% mutate(q6_2_1_r = ifelse(q6_2_1 == 7,NA,q6_2_1))
vdata1$q6_2_1_r %>% table()

#2回以上摂取
vdata1 <- vdata1 %>% mutate(TwoDose = ifelse(q6_2_1_r == 1 ,1,0))
vdata1$TwoDose %>% table()
#欠損を変換した場合にはq6_2_1 == 

#1回以上摂取
vdata1 <- vdata1 %>% mutate(OneDose = ifelse(q6_2_1_r <= 3,1,0))
vdata1$Dose %>% table()

```
★練習問題
・大卒以上である場合に１、そうでない場合に０をとる2値変数をCollegeという変数名で、配偶者についてはSCollegeという変数名で作成してください。
学生の質問はq3_1という変数で以下の定義です

1 	中学校／卒業・修了

2 	中学校／中退

3 	私立高校／卒業・修了

4 	私立高校／中退

5 	国立・公立高校／卒業・修了

6 	国立・公立高校／中退

7 	専門学校／卒業・修了

8 	専門学校／中退

9 	短大・高専／卒業・修了

10 	短大・高専／中退

11 	私立大学／卒業・修了

12 	私立大学／中退

13 	国立大学／卒業・修了

14 	国立大学／中退

15 	公立大学（県立や市立など）／卒業・修了

16 	公立大学（県立や市立など）／中退

17 	大学院／卒業・修了

18 	大学院／中退

```{r}
vdata1 <- vdata1 %>% mutate(College = ifelse(q3_1 == 11 | q3_1 == 13 | q3_1 == 15 | q3_1 >= 17,1,0))
vdata1$College %>% mean()

vdata1 <- vdata1 %>% mutate(SCollege = ifelse(q3_2 == 11 | q3_2 == 13 | q3_2 == 15 | q3_2 >= 17,1,0))
vdata1$SCollege %>% mean()
```

★練習問題
世帯所得を調査した変数はq25で定義は以下です。「答えたくない」「分からない」という回答を除いて、中位所得以上の世帯が１となるような2値変数（MIncome）を作成してください。

1 	世帯の収入はない 　 　

2 	５０万円未満 　 　

3 	５０万円以上１００万円未満 　 　

4 	１００万円以上２００万円未満 　 　

5 	２００万円以上３００万円未満 　 　

6 	３００万円以上４００万円未満 　 　

7 	４００万円以上５００万円未満 　 　

8 	５００万円以上６００万円未満 　 　

9 	６００万円以上７００万円未満 　 　

10 	７００万円以上８００万円未満 　 　

11 	８００万円以上９００万円未満 　 　

12 	９００万円以上１，０００万円未満 　 　

13 	１，０００万円以上１，２００万円未満 　 　

14 	１，２００万円以上１，４００万円未満 　 　

15 	１，４００万円以上１，６００万円未満 　 　

16 	１，６００万円以上１，８００万円未満 　 　

17 	１，８００万円以上２，０００万円未満 　 　

18 	２，０００万円以上 　 　

19 	答えたくない 　 　

20 	分からない 　 　



```{r}
vdata1 <- vdata1 %>% mutate(MIncome = ifelse(q25 >= 19, NA, ifelse(q25 >= median(q25),1,0)))
vdata1$MIncome %>% mean(,na.rm = TRUE)

#vdata1$q25 < 19の範囲で計算されていることを確認
mean(vdata1$MIncome[vdata1$q25 < 19])
median(vdata1$q25[vdata1$q25 < 19])
```

2つのカテゴリにしたい場合は上記のif_elseが良いですが、3つ以上にしたい場合はcase_whenが便利です。 case_whenはcase_when(条件A ~ 条件が成り立つ場合の値, 条件B ~ 条件が成り立つ場合の値...と書いていきます。

q13_1は「２０２１年６月～現在において、下記の時間は、１日あたり（平均）どれくらいでしたか。／仕事や勉強でのＶＤＴ作業」という質問に対する回答で以下のカテゴリから選びます

1 	なし（０時間） 　 　

2 	１日あたり３０分未満 　 　

3 	１日あたり３０分程度 　 　

4 	１日あたり１時間 　 　

5 	１日あたり２時間 　 　

6 	１日あたり３時間 　 　

7 	１日あたり４～５時間 　 　

8 	１日あたり６～７時間 　 　

9 	１日あたり８～９時間 　 　

10 	１日あたり１０～１１時間 　 　

11 	１日あたり１２時間以上 　 　

12 	わからない 　 　


このままでは解析に使えませんので、分単位でおおよその投入時間を割り当ててみたいと思います。割り当てルールは以下のようにしましょう。

1 0
2 15
3 30
4 60
5 120
6 180
7 270
8 390
9 450
10 630
11 720
12 NA

```{r}
vdata1 <- vdata1 %>% mutate(q13_1_r = case_when(q13_1 == 1 ~ 0,
                                                q13_1 == 2 ~ 15,
                                                q13_1 == 3 ~ 30,
                                                q13_1 == 4 ~ 60,
                                                q13_1 == 5 ~ 120,
                                                q13_1 == 6 ~ 180,
                                                q13_1 == 7 ~ 270,
                                                q13_1 == 8 ~ 390,
                                                q13_1 == 9 ~ 450,
                                                q13_1 == 10 ~ 630,
                                                q13_1 == 11 ~ 720)
                            )

vdata1$q13_1_r %>%  table()
#欠損値（q13_1 == 12）は無視して平均を算出
vdata1$q13_1_r %>% mean( ,na.rm = TRUE)
```
q13_1からq13_9はすべて生活時間の質問で回答形式は同じです。q13_1で行ったような変換作業を行うにはどうしたらいいでしょうか？変数名はq13_1やq13_9のように末尾の数字のみが変ることに着目してforを用いて、変換前の変数名（e.g., q13_2）と変換後の変数名(e.g., q13_2_r)を作成します。変数名はpasteという関数をよく用います。paste("q13","5", sep = "_") であればq13_5という変数名を指します。printという関数を用いて変数名を出力してみましょう


```{r}
for (n in 1:9){
  var_name = paste("q13",n, sep = "_") 
  print(var_name)
}
```
paste("q13",1:9,sep = "_")でq13_1からq13_9までの変数リストを作成し、末尾にrがつくように元の変数を加工します。q13_1のケースであれば「.」にこの変数名が代入される形で計算が繰り返されます
```{r}
vdata1 <- vdata1 %>% mutate_at(c(paste("q13",1:9,sep = "_")),
                     funs(r = case_when(. == 1 ~ 0,
                                      . == 2 ~ 15,
                                      . == 3 ~ 30,
                                      . == 4 ~ 60,
                                      . == 5 ~ 120,
                                      . == 6 ~ 180,
                                      . == 7 ~ 270,
                                      . == 8 ~ 390,
                                      . == 9 ~ 450,
                                      . == 10 ~ 630,
                                      . == 11 ~ 720)))


#q13_9_rを確認
vdata1$q13_9_r %>% table()
vdata1$q13_9 %>% table()

```
★練習問題
・q21_1からq21_6は「Kessler Psychological Distress Scale（K6）」という鬱病のスクリーニングテストです。過去1か月間に「神経過敏に感じましたか」「絶望的だと感じましたか」「そわそわ，落ち着かなく感じましたか」「気分が沈み込んで，何が起こっても気が晴れないように感じましたか」「何をするのも骨折りだと感じましたか」「自分は価値のない人間だと感じましたか」という6項目の質問に対して、「まったくない」（0点）「少しだけ」（1点）「ときどき」（2点）「たいてい」（3点）「いつも」（4点）で回答。合計点数が9点以上の場合、心の健康が崩れている可能性が高いとされます。

ただこの調査では調査対象者は以下のように回答しています。

1 	いつも

2 	たいてい

3 	ときどき

4 	少しだけ

5 	まったくない


このままでは合計スコアを算出できないので、「いつも」が「4」点、「まったくない」が「0」点になるように変数を加工してください。合計点をK6Scoreという変数名で作成し平均を計算してください。


```{r}
vdata1 <- vdata1 %>% mutate_at(c(paste("q21",1:6,sep = "_")),
                     funs(r = case_when(. == 1 ~ 4,
                                      . == 2 ~ 3,
                                      . == 3 ~ 2,
                                      . == 4 ~ 1,
                                      . == 5 ~ 0,)))

vdata1 <- vdata1 %>% mutate(K6Score = q21_1_r + q21_2_r + q21_3_r + q21_4_r + q21_5_r + q21_6_r)
vdata1$K6Score %>% mean()

```
元の数字にマイナス１を書けて５を足せば同じ変換をしたことになるので、以下のように書いてもいいでしょう。
```{r}
vdata1 <- vdata1 %>% mutate_at(c(paste("q21",1:6,sep = "_")),
                     funs(r = .*(-1) + 5))

vdata1 <- vdata1 %>% mutate(K6Score = q21_1_r + q21_2_r + q21_3_r + q21_4_r + q21_5_r + q21_6_r)
vdata1$K6Score %>% mean()

```
★練習問題
q27_1からq27_6は他者への信頼に関する質問です。「あなたの地域の人は機会があればあなたを利用しようとしている」といった意見に対して以下の中から回答を選びます。

1 	完全にそう思う

2 	そう思う

3 	どちらかといえばそう思う

4 	どちらともいえない

5 	どちらかといえばそう思わない

6 	そう思わない

7 	全くそう思わない

つまり、他者を信頼する人ほど数字が大きくなるように回答しています。しかしq27_5だけ「あなたの地域の人は基本的には正直だ」という意見で、他者を信頼しない人ほど数字が大きくなるように回答しています。q27_5の質問のみ、1から7の回答を逆にしたあとに、すべの回答を足し合わせて信頼スコア（TrustScore）を作成してください。
```{r}
vdata1 <- vdata1 %>% mutate(q27_5_r = q27_5*-1 + 8)
vdata1 <- vdata1 %>% mutate(TrustScore = q27_1 + q27_2 +q27_3 + q27_4 + q27_5_r + q27_6)

```

群別の属性の確認


群別の属性（e.g., 男女別のK6スコアの平均）はtapplyを用いて以下のように書くことができます。


```{r}
tapply(vdata1$K6Score, vdata1$Fem, mean)

```

パイプを用いて同じ演算をすると以下のようになります。

```{r}

vdata1 %>% group_by(Fem) %>% summarize(mean_K6Score = mean(K6Score,na.rm = TRUE))
```
男女別生年別のK6スコアも以下のように計算できます。
```{r}

vdata1 %>% group_by(Fem,sc2_1_1) %>% summarize(mean_K6Score = mean(K6Score,na.rm = TRUE))

```
★練習問題
q10は「新型コロナウイルスのワクチンの有効性については多くの研究が行われています。１００人がファイザーやモデルナのワクチンを２回接種した場合、そのうち何人が新型コロナウイルス感染症の重症化の危険から守られると思いますか。／人」という質問に対する回答です。正解は95％です。

・男女、成年別に回答の平均値を求めてください。

・男女、学歴別に回答の平均値を求めてください。

・都道府県別に回答の平均値を求めてください。


```{r}
vdata1$q10_1 %>% table()

vdata1 %>% group_by(Fem,sc2_1_1) %>% summarize(mean_prob = mean(q10_1,na.rm = TRUE))

vdata1 %>% group_by(Fem,College) %>% summarize(mean_prob = mean(q10_1,na.rm = TRUE))

tapply(vdata1$q10_1, vdata1$sc4, mean)
```


Data Visualization

K6スコアが高い人ほどワクチンの有効性をしんじなくなるのか散布図で確認してみましょう。
```{r}

p <- ggplot(data = vdata1, mapping = aes(x = K6Score, y =q10_1))
p + geom_point() + geom_smooth()

#ラベルなどを着けて加工
p <- ggplot(data = vdata1, mapping = aes(x = K6Score, y =q10_1))
p + geom_point(color="purple") + geom_smooth() +
  labs(x = "K6 Score", y = "Subjective Efficacy of Covid Vaccines",
       title = "Mental Health and Vaccines", caption = "Takaku sensei's original data")
  
```

```{r}
p <- ggplot(data = vdata1, mapping = aes(x = K6Score, y =TrustScore))
p + geom_point(color="orange") + geom_smooth()+
  labs(x = "K6 Score", y = "Trust Score",
       title = "Mental Health and Trust", caption = "Takaku sensei's original data")

```

作成した図表を保存してみましょう。図の保存はggsaveというコマンドで以下のように行うことができます。

```{r}
library(ggplot2)
library(tidyverse)

p <- ggplot(data = vdata1, mapping = aes(x = K6Score, y =TrustScore))
p + geom_point(color="orange") + geom_smooth()+
  labs(x = "K6 Score", y = "Trust Score",
       title = "Mental Health and Trust", caption = "Takaku sensei's original data")

#setwdの場所に保存する場合
#ggsave(filename = "my_figure.pdf")

#指定したフォルダの下にfigureというフォルダがあってそこに保存したい場合にはhereというパッケージをインストールして使うと便利
install.packages("here", repos = "https://cran.r-project.org/")
library(here)
ggsave(here("figure", "my_figure.pdf"))

```

棒グラフとヒストグラム

K6スコアの分布を棒グラフとヒストグラムで書いてみよう。二つのグラフはggplotの箇所は全く同じで、プロットタイプを指定するgeom_以下が変るだけ。

```{r}

#棒グラフ
p <- ggplot(data = vdata1, mapping = aes(x = K6Score))
p + geom_bar()

#ヒストグラム
p <- ggplot(data = vdata1, mapping = aes(x = K6Score))
p + geom_histogram()


```

棒グラフで男女の内訳がわかるように記載してみよう。この時、Femは現在女性ならば１、男性ならば０が格納されているが、このままではグラフを作成してくれない。文字列に変換してから作図すると上手く作成できる。


```{r}

vdata1 <- vdata1 %>% mutate(gender = ifelse(Fem == 1, "Female", "Male"))

p <- ggplot(data = vdata1, mapping = aes(x = K6Score, fill = gender))
p + geom_bar()
```

データセットによっては初めかgenderのように文字列が記載されているものがある。データの型を確認する際にはstr(df)と入力する。今試みにstr(vdata1$変数名)と入力すると以下が出力される。
```{r}
str(vdata1$sc1_1)
str(vdata1$TrustScore)
str(vdata1$gender)
```
intと書かれているのが型です。

これは整数(integer)を表します。

以下の型はすべて数値として扱われます。

int: integer, 整数

dbl: double, 実数

num: numeric, 数値

chr: character, 文字列

genderは文字列として認識されています。文字列として認識されている変数を数値に直す必要がある場合もあります。その場合にはas_factor()を用いることで、数値解析に用いることができます。
```{r}
vdata1 <- vdata1 %>% mutate(gender_factor = as_factor(gender))

vdata1$gender_factor %>% table()
str(vdata1$gender_factor)

vdata1$Fem %>% table()
str(vdata1$Fem)
```
